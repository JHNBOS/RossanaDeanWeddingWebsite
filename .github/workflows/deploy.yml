name: CI / CD for Angular
on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up node.js
        uses: actions/setup-node@v3.3.0
        with:
          node-version: '16'
          cache: 'npm'

      - name: Install dependencies
        run: npm i

      - name: Replace secret
        uses: cschleiden/replace-tokens@v1.1
        with:
          tokenPrefix: '{'
          tokenSuffix: '}'
          files: 'src/environments/environment.prod.ts'
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_DOMAIN: ${{ secrets.FIREBASE_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SENDER_ID: ${{ secrets.FIREBASE_SENDER_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}

      - uses: bluwy/substitute-string-action@v1
        id: sub1
        with:
          _input-file: 'src/environments/environment.prod.ts'
          {FIREBASE_API_KEY}: ${{ secrets.FIREBASE_API_KEY }}
          
      - uses: bluwy/substitute-string-action@v1
        id: sub2
        with:
          _input-file: 'src/environments/environment.prod.ts'
          {FIREBASE_APP_ID}: ${{ secrets.FIREBASE_APP_ID }}
      
      - uses: bluwy/substitute-string-action@v1
        id: sub3
        with:
          _input-file: 'src/environments/environment.prod.ts'
          {FIREBASE_DOMAIN}: ${{ secrets.FIREBASE_DOMAIN }}
          
      - uses: bluwy/substitute-string-action@v1
        id: sub
        with:
          _input-file: 'src/environments/environment.prod.ts'
          {FIREBASE_PROJECT_ID}: ${{ secrets.FIREBASE_PROJECT_ID }}
          
      - uses: bluwy/substitute-string-action@v1
        id: sub4
        with:
          _input-file: 'src/environments/environment.prod.ts'
          {FIREBASE_SENDER_ID}: ${{ secrets.FIREBASE_SENDER_ID }}
          
      - uses: bluwy/substitute-string-action@v1
        id: sub5
        with:
          _input-file: 'src/environments/environment.prod.ts'
          {FIREBASE_STORAGE_BUCKET}: ${{ secrets.FIREBASE_STORAGE_BUCKET }}

      - name: Build
        run: npm run gdeploy

      - name: GitHub Pages action
        # You may pin to the exact commit or the version.
        # uses: peaceiris/actions-gh-pages@bbdfb200618d235585ad98e965f4aafc39b4c501
        uses: peaceiris/actions-gh-pages@v3.7.3
        with:
         
          # Set a generated GITHUB_TOKEN for pushing to the remote branch.
          github_token: ${{ secrets.GITHUB_TOKEN }} # optional
          # Set a personal access token for pushing to the remote branch.
          # personal_token: # optional
          # Set a target branch for deployment.
          publish_branch: gh-pages # optional, default is gh-pages
          # Set an input directory for deployment.
          publish_dir: dist/docs # optional, default is public
          # Set an destination subdirectory for deployment.
          destination_dir: docs # optional, default is 
          # Set an external repository (owner/repo).
          #external_repository: # optional
          # If empty commits should be made to the publication branch
          #allow_empty_commit: # optional, default is false
          # If existing files in the publish branch should be not removed before deploying
          #keep_files: # optional, default is false
          # Keep only the latest commit on a GitHub Pages branch
          #force_orphan: # optional, default is false
          # Set Git user.name
          #user_name: # optional
          # Set Git user.email
          #user_email: # optional
          # Set a custom commit message with a triggered commit hash
          #commit_message: # optional
          # Set a custom full commit message without a triggered commit hash
          #full_commit_message: # optional
          # Set tag name
          #tag_name: # optional
          # Set tag message
          #tag_message: # optional
          # Enable the GitHub Pages built-in Jekyll
          #enable_jekyll: # optional, default is false
          # An alias for enable_jekyll to disable adding .nojekyll file to master or gh-pages branches
          disable_nojekyll: true # optional, default is false
          # Set custom domain
          # cname: # optional
          # Set files or directories to exclude from a publish directory.
          # exclude_assets: # optional, default is .github
